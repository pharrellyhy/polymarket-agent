# Consolidated Code Review

Date: 2026-02-26
Repository: `polymarket-agent`
Review scope: recent changed code (diff review) + holistic project structure/agent readiness review

## Deduplication

- Agents run: `Diff Review`, `Holistic Review`
- Duplicate findings removed: 0 (no overlapping issues identified)

## Findings (Ordered by Severity)

### High

#### 1. Prompt injection risk from untrusted market content in AI analyst prompt
- File path and line number: `src/polymarket_agent/strategies/ai_analyst.py:85`
- Severity: high
- Category: Diff
- Description: The Claude prompt is built by interpolating `market.question` and `market.description` directly. Those values can come from user-created Polymarket markets, and the MCP tool exposes this path to external agents. Without sanitization or bounding, malicious market text can inject instructions into the LLM prompt and influence behavior or induce disclosure of sensitive context.
- Suggested fix: Sanitize and bound market text before prompt construction (truncate length, strip/escape control sequences, and copy only validated fields). Prefer a structured prompt with explicit delimiters and a curated market summary instead of raw market description text. Consider restricting AI analysis to vetted markets if needed.

### Medium

#### 2. Orchestrator ignores configured execution mode and always uses paper trader
- File path and line number: `src/polymarket_agent/orchestrator.py:42`
- Severity: medium
- Category: Holistic
- Description: The orchestrator instantiates `PaperTrader` unconditionally and does not switch executor implementation based on `AppConfig.mode`. This creates a mismatch between documented configuration modes (`paper`, `live`, `mcp`, etc.) and runtime behavior, which can mislead operators and weakens architectural boundaries.
- Suggested fix: Add an executor factory (or mode switch) that maps `AppConfig.mode` to the appropriate executor implementation. If a mode is not implemented, fail fast with a clear error or warning instead of silently defaulting to paper trading.

#### 3. README AI configuration docs omit required API credential/dependency setup
- File path and line number: `README.md:86`
- Severity: medium
- Category: Holistic
- Description: The README describes enabling `ai_analyst` and tuning Claude-related settings but does not document required environment setup (for example `ANTHROPIC_API_KEY`) or the dependency/runtime prerequisites for AI-backed features. This leaves agents and developers without the minimum instructions to successfully use the feature.
- Suggested fix: Document required environment variables (including `ANTHROPIC_API_KEY`), dependency requirements, and setup steps for AI features in `README.md` and/or `CLAUDE.md`. Include a short validation step so operators can confirm the integration is configured correctly.

### Low

#### 4. Arbitrageur `min_deviation` config appears unused in signal decision logic
- File path and line number: `src/polymarket_agent/strategies/arbitrageur.py:27`
- Severity: low
- Category: Diff
- Description: The configurable `_min_deviation` value is set in `configure()` but is not used in `_check_price_sum()`. The strategy therefore appears to ignore a newly exposed config threshold, making configuration misleading and increasing maintenance confusion.
- Suggested fix: Apply `_min_deviation` in the deviation gating logic (for example, require deviation to exceed the configured threshold before signaling) or remove the unused config field if it is not intended to affect behavior.

#### 5. Market maker `max_inventory` config appears unused and unenforced
- File path and line number: `src/polymarket_agent/strategies/market_maker.py:27`
- Severity: low
- Category: Diff
- Description: `_max_inventory` is configurable but is not checked when generating signals/quotes. Operators may assume exposure caps are enforced when they are not, which is a behavior/documentation mismatch and dead configuration risk.
- Suggested fix: Enforce `_max_inventory` when generating buy/sell signals (using current position or inventory state), or remove the configuration parameter until enforcement is implemented.

## Summary

- Total issues: 5
- Severity breakdown: `critical: 0`, `high: 1`, `medium: 2`, `low: 2`
- Agents that ran:
  - `AGENT 1: Diff Review` (uncommitted + recent commits via `git diff`, `git diff --cached`, `git log --oneline -5`, `git diff HEAD~5`)
  - `AGENT 2: Holistic Review` (project structure, config/docs, agent harness readiness)
- Overall assessment: The project is generally well-structured with clear separation of major layers and strong agent-oriented guidance, but there is one significant security risk in AI prompt construction from untrusted market text, plus a few config/behavior mismatches (executor mode and strategy parameters) that could mislead operators and reduce reliability.
