<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Polymarket Agent Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f1117; color: #e1e4e8; padding: 24px; }
  h1 { font-size: 1.5rem; margin-bottom: 8px; }
  .subtitle { color: #8b949e; margin-bottom: 24px; font-size: 0.9rem; }
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; }
  .card-label { color: #8b949e; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; }
  .card-value { font-size: 1.6rem; font-weight: 600; margin-top: 4px; }
  .positive { color: #3fb950; }
  .negative { color: #f85149; }
  .section { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin-bottom: 24px; }
  .section h2 { font-size: 1.1rem; margin-bottom: 12px; }
  canvas { width: 100% !important; max-height: 300px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  th { text-align: left; padding: 8px; color: #8b949e; border-bottom: 1px solid #30363d; }
  td { padding: 8px; border-bottom: 1px solid #21262d; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
  .badge-buy { background: rgba(63, 185, 80, 0.15); color: #3fb950; }
  .badge-sell { background: rgba(248, 81, 73, 0.15); color: #f85149; }
  .badge-active { background: rgba(88, 166, 255, 0.15); color: #58a6ff; }
  .badge-triggered { background: rgba(63, 185, 80, 0.15); color: #3fb950; }
  .badge-cancelled { background: rgba(139, 148, 158, 0.15); color: #8b949e; }
  .badge-stop_loss { background: rgba(248, 81, 73, 0.15); color: #f85149; }
  .badge-take_profit { background: rgba(63, 185, 80, 0.15); color: #3fb950; }
  .badge-trailing_stop { background: rgba(210, 153, 34, 0.15); color: #d29922; }
  .diff-old { color: #f85149; text-decoration: line-through; }
  .diff-new { color: #3fb950; }
  #status { font-size: 0.8rem; color: #8b949e; text-align: right; margin-bottom: 8px; }
</style>
</head>
<body>

<h1>Polymarket Agent</h1>
<p class="subtitle">Monitoring Dashboard</p>
<p id="status">Loading...</p>

<div class="grid">
  <div class="card"><div class="card-label">Balance</div><div class="card-value" id="balance">--</div></div>
  <div class="card"><div class="card-label">Total Value</div><div class="card-value" id="total-value">--</div></div>
  <div class="card"><div class="card-label">Positions</div><div class="card-value" id="positions">--</div></div>
  <div class="card"><div class="card-label">Signals (24h)</div><div class="card-value" id="signal-count">--</div></div>
</div>

<div class="section">
  <h2>Portfolio Value</h2>
  <canvas id="pnl-chart"></canvas>
</div>

<div class="section">
  <h2>Open Positions</h2>
  <table>
    <thead><tr><th>Token</th><th>Shares</th><th>Entry Price</th><th>Current Price</th><th>Unrealized P&L</th><th>P&L %</th></tr></thead>
    <tbody id="positions-body"></tbody>
  </table>
</div>

<div class="section">
  <h2>Strategy Performance</h2>
  <table>
    <thead><tr><th>Strategy</th><th>Trades</th><th>Win Rate</th><th>Net P&L</th><th>Signals</th></tr></thead>
    <tbody id="strategy-body"></tbody>
  </table>
</div>

<div class="section">
  <h2>Recent Trades</h2>
  <table>
    <thead><tr><th>Time</th><th>Strategy</th><th>Market</th><th>Side</th><th>Price</th><th>Size</th></tr></thead>
    <tbody id="trades-body"></tbody>
  </table>
</div>

<div class="section">
  <h2>Recent Signals</h2>
  <table>
    <thead><tr><th>Time</th><th>Strategy</th><th>Market</th><th>Side</th><th>Confidence</th><th>Status</th></tr></thead>
    <tbody id="signals-body"></tbody>
  </table>
</div>

<div class="section">
  <h2>Conditional Orders</h2>
  <table>
    <thead><tr><th>Created</th><th>Type</th><th>Status</th><th>Market</th><th>Trigger Price</th><th>Size</th><th>Strategy</th><th>Triggered At</th></tr></thead>
    <tbody id="orders-body"></tbody>
  </table>
</div>

<div class="section">
  <h2>Config Change History</h2>
  <table>
    <thead><tr><th>Time</th><th>Source</th><th>Changes</th></tr></thead>
    <tbody id="config-body"></tbody>
  </table>
</div>

<script>
let pnlChart = null;

async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) {
    throw new Error(`Request failed (${res.status}) for ${url}`);
  }
  return res.json();
}

function toNum(value, fallback = 0) {
  const num = Number(value);
  return Number.isFinite(num) ? num : fallback;
}

function fmt(n) {
  return '$' + toNum(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function fixed(n, digits) {
  return toNum(n).toFixed(digits);
}

function shortId(value, width = 12) {
  const text = String(value || '');
  if (!text) return '--';
  return text.length > width ? `${text.slice(0, width)}...` : text;
}

function renderRows(bodyId, rows, colspan, emptyText = 'No data') {
  const body = document.getElementById(bodyId);
  body.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="${colspan}">${emptyText}</td></tr>`;
}

async function refresh() {
  try {
    const [portfolio, trades, signals, snapshots, positions, stratPerf, condOrders, configChanges] = await Promise.all([
      fetchJSON('/api/portfolio'),
      fetchJSON('/api/trades?limit=20'),
      fetchJSON('/api/signals?limit=20'),
      fetchJSON('/api/snapshots?limit=50'),
      fetchJSON('/api/positions'),
      fetchJSON('/api/strategy-performance'),
      fetchJSON('/api/conditional-orders?limit=50'),
      fetchJSON('/api/config-changes?limit=20'),
    ]);

    document.getElementById('balance').textContent = fmt(portfolio.balance);
    document.getElementById('total-value').textContent = fmt(portfolio.total_value);
    document.getElementById('positions').textContent = Object.keys(portfolio.positions || {}).length;
    document.getElementById('signal-count').textContent = signals.length;

    // Trades table
    renderRows(
      'trades-body',
      trades.map(t =>
        `<tr><td>${t.timestamp || '--'}</td><td>${t.strategy || '--'}</td><td>${shortId(t.market_id)}</td>` +
        `<td><span class="badge badge-${t.side}">${t.side || '--'}</span></td>` +
        `<td>${fixed(t.price, 4)}</td><td>${fmt(t.size)}</td></tr>`
      ),
      6
    );

    // Signals table
    renderRows(
      'signals-body',
      signals.map(s =>
        `<tr><td>${s.timestamp || '--'}</td><td>${s.strategy || '--'}</td><td>${shortId(s.market_id)}</td>` +
        `<td><span class="badge badge-${s.side}">${s.side || '--'}</span></td>` +
        `<td>${fixed(s.confidence, 2)}</td><td>${s.status || '--'}</td></tr>`
      ),
      6
    );

    // P&L chart
    const sorted = snapshots.slice().reverse();
    const labels = sorted.map(s => (s.timestamp ? String(s.timestamp).slice(0, 10) : ''));
    const values = sorted.map(s => toNum(s.total_value));

    if (pnlChart) {
      pnlChart.data.labels = labels;
      pnlChart.data.datasets[0].data = values;
      pnlChart.update();
    } else {
      const ctx = document.getElementById('pnl-chart').getContext('2d');
      pnlChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Value',
            data: values,
            borderColor: '#58a6ff',
            backgroundColor: 'rgba(88, 166, 255, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 2,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
            y: { ticks: { color: '#8b949e', callback: v => '$' + v }, grid: { color: '#21262d' } },
          }
        }
      });
    }

    // Positions table
    renderRows(
      'positions-body',
      positions.map(p => {
        const pnl = toNum(p.unrealized_pnl);
        const cls = pnl >= 0 ? 'positive' : 'negative';
        return `<tr><td>${shortId(p.token_id)}</td><td>${toNum(p.shares)}</td>` +
          `<td>${fixed(p.avg_price, 4)}</td><td>${fixed(p.current_price, 4)}</td>` +
          `<td class="${cls}">${fmt(pnl)}</td>` +
          `<td class="${cls}">${fixed(p.unrealized_pnl_pct, 2)}%</td></tr>`;
      }),
      6
    );

    // Strategy performance table
    renderRows(
      'strategy-body',
      stratPerf.map(s => {
        const netPnl = toNum(s.net_pnl);
        const cls = netPnl >= 0 ? 'positive' : 'negative';
        return `<tr><td>${s.strategy || '--'}</td><td>${toNum(s.trade_count)}</td>` +
          `<td>${fixed(s.win_rate, 1)}%</td>` +
          `<td class="${cls}">${fmt(netPnl)}</td><td>${toNum(s.signal_count)}</td></tr>`;
      }),
      5
    );

    // Conditional orders table
    renderRows(
      'orders-body',
      condOrders.map(o =>
        `<tr><td>${o.created_at || '--'}</td>` +
        `<td><span class="badge badge-${o.order_type || 'active'}">${o.order_type || '--'}</span></td>` +
        `<td><span class="badge badge-${o.status || 'active'}">${o.status || '--'}</span></td>` +
        `<td>${shortId(o.market_id)}</td>` +
        `<td>${fixed(o.trigger_price, 4)}</td><td>${fmt(o.size)}</td>` +
        `<td>${o.parent_strategy || '--'}</td><td>${o.triggered_at || '--'}</td></tr>`
      ),
      8
    );

    // Config change history table
    renderRows(
      'config-body',
      configChanges.map(c => {
        const diff = c.diff && typeof c.diff === 'object' ? c.diff : {};
        const changes = Object.entries(diff).map(([path, delta]) => {
          const oldValue = delta && typeof delta === 'object' ? delta.old : null;
          const newValue = delta && typeof delta === 'object' ? delta.new : null;
          return `<span class="diff-old">${path}: ${JSON.stringify(oldValue)}</span> â†’ ` +
            `<span class="diff-new">${JSON.stringify(newValue)}</span>`;
        }).join('<br>');
        return `<tr><td>${c.timestamp || '--'}</td><td>${c.changed_by || '--'}</td><td>${changes || 'No changes'}</td></tr>`;
      }),
      3
    );

    document.getElementById('status').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
  } catch (e) {
    document.getElementById('status').textContent = 'Error: ' + e.message;
  }
}

refresh();
setInterval(refresh, 15000);
</script>
</body>
</html>
